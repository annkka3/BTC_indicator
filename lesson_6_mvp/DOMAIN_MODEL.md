# Доменная модель Alt Forecast Bot

Этот документ описывает предметную область сервиса: какие сущности существуют,
какие между ними связи и какие бизнес-правила считаются инвариантами.

Доменная модель не зависит от Telegram, HTTP, базы данных или внешних API.
Она описывает *что считается корректным состоянием рынка* и *какие сигналы из него извлекаются*.

---

## Базовые сущности

### Bar (OHLCV)

Свеча рынка для конкретной метрики и таймфрейма.

**Атрибуты**
- `metric` — рыночная метрика
- `timeframe` — таймфрейм
- `ts` — время закрытия бара (unix, ms)
- `o, h, l, c` — open / high / low / close
- `v` — объём (может отсутствовать)

**Инварианты**
- `l ≤ min(o, c) ≤ max(o, c) ≤ h`
- `(metric, timeframe, ts)` — уникальный ключ
- `ts` всегда задаётся в миллисекундах
- бары одного `(metric, timeframe)` строго упорядочены по `ts`

---

### Metric

Тип рыночной метрики, над которой ведётся анализ.

Используемые значения:
- `BTC`
- `USDT.D`
- `BTC.D`
- `TOTAL2`
- `TOTAL3`
- `ETHBTC`

Метрика определяет **экономический смысл движения** и его влияние на рынок альткоинов.
Сама по себе цена не интерпретируется без контекста метрики.

---

### Timeframe

Временной интервал агрегации баров.

Поддерживаемые значения:
- `15m`
- `1h`
- `4h`
- `1d`

Таймфрейм всегда является частью ключа бара и всех производных сигналов.

---

## Производные сущности

### Divergence

Сигнал расхождения между ценой и индикатором.

Дивергенция — это не “событие”, а **объект с жизненным циклом**.

**Атрибуты**
- `metric` — метрика (может быть `None` для парных/относительных сигналов)
- `timeframe`
- `indicator` — RSI / MACD / VOLUME / PAIR
- `implication` — влияние на альткоины
- `pivot_l_ts`, `pivot_r_ts` — пивоты
- `pivot_l_val`, `pivot_r_val`
- `detected_ts`
- `status` — `active | confirmed | invalid`
- `confirm_ts`, `confirm_grade`
- `invalid_ts`
- `score` — качество сигнала `[0.0 … 1.0]`
- `text` — краткое человекочитаемое описание

**Жизненный цикл**
active → confirmed
active → invalid


Возврат в `active` невозможен.

---

### Implication

Интерпретация движения метрики с точки зрения альткоинов.

Возможные значения:
- `bullish_alts`
- `bearish_alts`
- `neutral`

**Смысл**
Implication отвечает на вопрос:
> усиливает ли текущее движение интерес к альткоинам или наоборот вытягивает ликвидность.

**Базовые соответствия**
USDT.D ↑ → bearish_alts
USDT.D ↓ → bullish_alts

BTC.D ↑ → bearish_alts
BTC.D ↓ → bullish_alts

TOTAL2 / TOTAL3 ↑ → bullish_alts
TOTAL2 / TOTAL3 ↓ → bearish_alts

ETHBTC ↑ → bullish_alts

---

### Direction

Направление изменения величины.

Значения:
- `up`
- `down`
- `flat`

Используется для интерпретации дельт и расчёта импликаций.
`flat` определяется через эпсилон `eps`.

---

## Пользовательские сущности

### UserSettings

Персональные настройки пользователя Telegram-бота.

Хранит параметры визуализации и периодических отчётов:
- настройки пузырьков
- таймфреймы
- фильтры
- час ежедневного дайджеста
- сериализованные настройки графиков

Домен не интерпретирует UI-формат, только значения.

---

### Subscription

Факт подписки чата на периодические отчёты.

Минимальная сущность:
- `chat_id`

---

## Доменные сервисы

### DivergenceDetector

Отвечает за поиск дивергенций на последовательностях баров.

Поддерживаемые типы:
- RSI
- MACD
- Volume
- Pair (относительные)

Результатом всегда является объект `Divergence`
или отсутствие сигнала.

---

### ImplicationCalculator

Преобразует изменение метрики в `Implication`.

- определяет `Direction`
- применяет маппинг метрика → эффект для альткоинов

---

### MarketStateAnalyzer

Агрегирует несколько сигналов и метрик
для определения текущего рыночного режима.

Возвращает:
- risk-on / risk-off
- дополнительные режимы (если включены)

---

## Связи между сущностями

Bar ──► Metric
Bar ──► Timeframe

Divergence ──► Metric (опционально)
Divergence ──► Timeframe
Divergence ──► Implication

UserSettings ──► Telegram User
Subscription ──► Telegram Chat

---

## Границы домена

### В домене находятся
- правила корректности данных
- интерпретация метрик
- жизненные циклы сигналов
- расчёт импликаций и режимов

### В домене отсутствуют
- Telegram
- HTTP / FastAPI
- SQL
- кеши
- форматирование сообщений
- внешние API

---

## Расширение модели

Допускается:
- добавление новых `Metric`
- добавление новых `Timeframe`
- расширение типов дивергенций
- расширение пользовательских настроек через сериализуемые поля

Инварианты баров и жизненный цикл дивергенций при этом остаются неизменными.
